name: Run Tests

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          curl \
          jq \
          dnsutils \
          rsync \
          docker.io \
          docker-compose
        # Add the current user to the docker group to avoid using sudo for docker commands
        sudo usermod -aG docker $USER
        echo "Dependencies installed."

    - name: Run full lifecycle test
      run: |
        # Make test runner and main script executable
        chmod +x tests/run-tests.sh
        chmod +x backup-manager.sh

        # Use `sg` to run commands with the docker group membership
        echo "--- Stage 1: Pre-Installation Tests ---"
        sg docker -c "sudo ./tests/run-tests.sh" || exit 1

        echo "--- Stage 2: Installing Application ---"
        sg docker -c "./backup-manager.sh install --non-interactive --yes" || exit 1

        echo "--- Stage 3: Post-Installation Tests (No Backups) ---"
        sg docker -c "sudo ./tests/run-tests.sh" || exit 1

        echo "--- Stage 4: Creating First Backup ---"
        sg docker -c "./backup-manager.sh backup --non-interactive" || exit 1

        echo "--- Stage 5: Post-Backup Tests ---"
        sg docker -c "sudo ./tests/run-tests.sh" || exit 1

        echo "--- Full lifecycle test completed successfully! ---"
