name: Test with Vagrant (Experimental)

on:
  workflow_dispatch:  # Manual trigger only for now
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  test-vagrant:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Generous timeout for VM operations
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check system resources
      run: |
        echo "=== System Information ==="
        df -h
        free -h
        nproc
        lscpu | grep -E '^CPU\(s\)|^Model name|^Virtualization'
        echo "=========================="
    
    - name: Install Vagrant
      run: |
        # Install Vagrant
        wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
        sudo apt update
        sudo apt install -y vagrant
        
        # Verify installation
        vagrant --version
    
    - name: Install VirtualBox
      run: |
        # Install VirtualBox (without ext-pack to avoid license acceptance issues)
        sudo apt update
        sudo apt install -y virtualbox
        
        # Pre-accept VirtualBox Extension Pack license
        echo "virtualbox-ext-pack virtualbox-ext-pack/license select true" | sudo debconf-set-selections
        
        # Now install the extension pack
        sudo apt install -y virtualbox-ext-pack
        
        # Ensure VirtualBox kernel modules are loaded
        sudo modprobe vboxdrv || echo "âš ï¸  VirtualBox kernel module not available (expected in some CI environments)"
        
        # Start VirtualBox service
        sudo systemctl start vboxdrv || echo "âš ï¸  Could not start vboxdrv service"
        sudo systemctl start virtualbox || echo "âš ï¸  Could not start virtualbox service"
        
        # Check VirtualBox service status
        echo "=== VirtualBox Service Status ==="
        sudo systemctl status vboxdrv || true
        sudo systemctl status virtualbox || true
        
        # Test basic VirtualBox functionality
        echo "=== Testing VirtualBox COM Server ==="
        if VBoxManage list vms 2>/dev/null; then
          echo "âœ… VirtualBox COM server is working"
        else
          echo "âŒ VirtualBox COM server is not working"
          echo "This is expected in GitHub Actions (no nested virtualization)"
        fi
        
        # Check if VirtualBox can start (nested virtualization test)
        if VBoxManage list hostinfo 2>/dev/null | grep -q "Nested Paging"; then
          echo "âœ… Nested virtualization appears to be supported"
        else
          echo "âš ï¸  Nested virtualization may not be supported"
        fi
    
    - name: Test Vagrant Box Download
      run: |
        echo "Testing Vagrant box download..."
        timeout 300 vagrant box add ubuntu/jammy64 --provider virtualbox --box-version "~> 20240701.0.0" || {
          echo "âŒ Failed to download Vagrant box (timeout or error)"
          echo "This suggests GitHub runners may not support our Vagrant setup"
          exit 1
        }
        
        echo "âœ… Vagrant box downloaded successfully"
        vagrant box list
    
    - name: Test VM Creation (Light Test)
      run: |
        echo "Testing basic VM creation..."
        
        # First check if VirtualBox COM server is working
        if ! VBoxManage list vms 2>/dev/null; then
          echo "âŒ VirtualBox COM server is not working"
          echo "ğŸš« Skipping VM creation test - nested virtualization not supported"
          echo "ğŸ“‹ This is expected behavior in GitHub Actions standard runners"
          echo ""
          echo "ğŸ’¡ To run Vagrant tests, consider:"
          echo "   - Using GitHub's larger runners (paid feature)"
          echo "   - Running tests locally with './dev-test.sh'"
          echo "   - Using alternative CI providers with nested virtualization"
          exit 0  # Exit successfully since this is expected
        fi
        
        echo "âœ… VirtualBox COM server is working, proceeding with VM test..."
        
        # Create a minimal test Vagrantfile
        cat > Vagrantfile.test << 'EOF'
        Vagrant.configure("2") do |config|
          config.vm.box = "ubuntu/jammy64"
          config.vm.box_version = "~> 20240701.0.0"
          
          config.vm.provider "virtualbox" do |vb|
            vb.memory = "512"  # Minimal memory
            vb.cpus = 1
            vb.linked_clone = true
          end
          
          config.vm.provision "shell", inline: <<-SHELL
            echo "Hello from Vagrant VM!"
            uname -a
            df -h
          SHELL
        end
        EOF
        
        # Try to start a minimal VM
        export VAGRANT_VAGRANTFILE=Vagrantfile.test
        timeout 600 vagrant up || {
          echo "âŒ Failed to create VM"
          echo "GitHub runners may not support nested virtualization"
          vagrant status || true
          exit 1
        }
        
        echo "âœ… VM created successfully!"
        
        # Test SSH connection
        vagrant ssh -c "echo 'SSH connection works!'" || {
          echo "âŒ SSH connection failed"
          exit 1
        }
        
        echo "âœ… SSH connection works!"
        
        # Cleanup
        vagrant destroy -f
    
    - name: Run Full Test Suite (If VM Creation Succeeds)
      run: |
        # Only run if VirtualBox is working
        if ! VBoxManage list vms 2>/dev/null; then
          echo "ğŸš« Skipping full test suite - VirtualBox COM server not available"
          echo "ğŸ“‹ This step requires nested virtualization support"
          exit 0
        fi
        
        echo "ğŸš€ Running full test suite with our Vagrantfile..."
        
        # Use our actual Vagrantfile
        timeout 1800 ./dev-test.sh fresh || {
          echo "âŒ Full test suite failed"
          echo "Checking VM status..."
          vagrant status || true
          echo "Checking logs..."
          vagrant ssh primary -c "tail -50 /var/log/docker-backup-manager.log" || true
          exit 1
        }
        
        echo "ğŸ‰ Full test suite completed successfully!"
    
    - name: Cleanup
      if: always()
      run: |
        echo "Cleaning up VMs..."
        vagrant destroy -f || true
        vagrant box remove ubuntu/jammy64 || true
    
    - name: Test Results Summary
      if: always()
      run: |
        echo "=== Vagrant Test Results ==="
        
        # Check if VirtualBox COM server was working
        if VBoxManage list vms 2>/dev/null; then
          echo "ğŸ‰ AMAZING: GitHub runners CAN run VirtualBox!"
          echo "âœ… VirtualBox COM server is functional"
          echo "ğŸ¯ This means we can potentially use this workflow for automated testing"
          echo "ğŸ“ Note: This is unusual - most GitHub runners don't support nested virtualization"
        else
          echo "ğŸ“‹ EXPECTED: GitHub runners cannot run VirtualBox VMs"
          echo "âŒ VirtualBox COM server is not functional (nested virtualization not supported)"
          echo "âœ… However, Vagrant and VirtualBox installation succeeded"
          echo "âœ… Vagrant box download worked successfully"
          echo ""
          echo "ğŸ’¡ This is the typical behavior for GitHub Actions standard runners"
          echo ""
          echo "ğŸ”§ Alternatives for automated testing:"
          echo "   - Use GitHub's larger runners with nested virtualization (paid)"
          echo "   - Use Docker-based testing instead of VMs"
          echo "   - Use external CI services (CircleCI, GitLab CI with KVM)"
          echo "   - Run tests locally with './dev-test.sh'"
          echo "   - Create lighter integration tests without VMs"
        fi
        echo "=========================="